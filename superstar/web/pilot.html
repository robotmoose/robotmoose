<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">

<!-- example of how to style buttons and such
<style>
input[type="button"] {
    background-color: #FF33FF;
  -moz-border-radius: 15px;
  -webkit-border-radius: 15px;
  border: 2px solid #00FF00;
  padding: 5px;
}
</style>
-->

<script type="text/javascript" src="jscolor/jscolor.js"></script> <!-- Jscolor library for color picker-->

<!--Jquery files for interface additions-->
<script src="jquery/external/jquery/jquery.js"></script>
<script src="jquery/jquery-ui.js"></script>
<link href="jquery/jquery-ui.css" rel="stylesheet">

<script type=text/javascript>
/*
  JSON Testing
  Dr. Orion Lawlor, lawlor@alaska.edu, 2012-02-17
*/


/* Main update: display costs for user's selected values. */
function run() {
  document.getElementById('p_errorout').innerHTML="";
  try {

  } catch (err) {
    document.getElementById('p_errorout').innerHTML="Exception: "+err;
  }
}


/* Walk the DOM to get the client X,Y position of this element's topleft corner.
  From www.kirupa.com/snippets/examples/move_to_click_position.htm */
function getClientPosition(element) {
	var xPosition = 0;
	var yPosition = 0;
	while (element) {
		xPosition += (element.offsetLeft - element.scrollLeft + element.clientLeft);
		yPosition += (element.offsetTop - element.scrollTop + element.clientTop);
		element = element.offsetParent;
	}
	return { x: xPosition, y: yPosition };
}
/* Return the fractional mouse position of the mouse relative to this element.
   Returns x=0.0 at the left edge, x=1.0 at the right edge;
           y=0.0 at the top edge, y=1.0 at the bottom edge. */
function getMouseFraction(event,domElement) {
  var corner=getClientPosition(domElement);
  var xFrac=(event.clientX-corner.x)/domElement.scrollWidth;
  var yFrac=(event.clientY-corner.y)/domElement.scrollHeight;
  return { x:xFrac, y:yFrac };
}

// Round this number to the nearest thousandth, making it look pretty.
function pretty(number) {
	return Math.round(number*1000)/1000.0;
}

// Clamp this value between lo and hi
function clamp(v,lo,hi) {
	if (v<lo) return lo;
	if (v>hi) return hi;
	else return v;
}

// Return an "empty" robot power object, with everything stationary
function emptyPower()
{
	return {L:0, R:0, dump:0, mine:0, arms:0};
}

function emptyLED()
{
 	//return {R:this.color.rgb[0], G:this.color.rgb[1], B:this.color.rgb[3]};
         return{On:false, Demo:false, R:0, G:0, B:0};
}


// This class stores our last-used piloting command
var pilot={
	/* Power to each actuator */
	power: emptyPower(),

	/* Time, in seconds, of last pilot command */
	time:0,

	/*LED bits */
	LED: emptyLED(),

        /* Scripted command to run */
	cmd: { run: "", arg:"" },

	/* Authorization hash (todo) */
	auth:"ffe0"
};

function LEDtoggle(){
	pilot.LED.On = document.getElementById("LEDtoggle").checked;
/*      if(!pilot.LED.On) { 
		pilot.LED.Demo=false; // Auto turn-off demo mode when LED is disabled 
		document.getElementById("LEDdemo").checked=false; // Untick LED Demo checkbox
	}
        console.log(document.getElementById("LEDtoggle").checked);
	console.log(pilot.LED.On); // print current value of LEDtoggle onto the console for debugging
*/
// If LED is Off, make LED Demo unclickable 
	if(document.getElementById("LEDtoggle").checked) {document.getElementById("LEDdemo").disabled=false;}
	else {document.getElementById("LEDdemo").disabled=true;}
	pilot_send();

}
//Toggle Demo mode. LED ramp up and turn off cycle
function LEDdemo()
{
         pilot.LED.Demo=document.getElementById("LEDdemo").checked;
	/*if(!pilot.LED.Demo)pilot.LED.Demo=true;
        else pilot.LED.Demo=false;*/
	pilot_send();
}



// Return the current wall clock time, in seconds
function pilot_time() {
	return (new Date()).getTime()/1000.0;
}

// This counts outstanding network requests
var networkBusy=0;

// Send our last-used piloting command out across the network
function pilot_send() {
	var host=// "http://localhost:8080"+ // <- explicit host not needed, browser will use the .html server by default.
		"/superstar/";
	var robot=document.getElementById('robot_name').value;
	var url_start=host+robot;

	if (networkBusy>1)
	{ // prevent overloading network: skip sending if already busy
		document.getElementById('p_outputNet').innerHTML="network lag";
		return;
	}

	networkBusy++;
	var send_time=pilot.time=pilot_time();
	var pilotStr=JSON.stringify(pilot);
	console.log(pilotStr);
	//var LEDStr=JSON.stringify(LED); // send current LED state
	var url=url_start+"/pilot?set="+encodeURIComponent(pilotStr);
	var xmlhttp=new XMLHttpRequest();
	xmlhttp.onreadystatechange=function()
	{ // this function called when network progress happens
		if(xmlhttp.readyState!=4) return;
		var status="Network Error";
		if (xmlhttp.status==200)
		{
			status="Data sent at t="+send_time+" ("+pretty(pilot_time()-send_time)+" second roundtrip)";
			if (networkBusy>1) status+=" ["+networkBusy+" requests in flight]";
		}
		document.getElementById('p_outputNet').innerHTML=status;
		networkBusy--;
	}
	xmlhttp.open("GET",url,true);
	xmlhttp.send(null);
}

// This function is called at every mouse event.
//   upState: 0 if down, 1 if up, 2 if not changing
var mouse_down=0;
function pilot_mouse(event,upState) {
// Allow user to set maximum power
	var maxPower=0.7;
	var powerUI=document.getElementById('robot_power').value*0.01;
	if (isNaN(powerUI)) maxPower=0.0;
	else if (powerUI<maxPower) { maxPower=powerUI; }
	//if (maxPower<0.15) { maxPower=0.15; } // limit's low end speed

	var arrowDiv=document.getElementById('pilot_arrows');
	var frac=getMouseFraction(event,arrowDiv);
	var str="";
	// str+="Mouse "+frac.x+" "+frac.y+"<br>\n";

	var dir={ forward: pretty(0.5-frac.y), turn:pretty(frac.x-0.5) };
	// if (Math.abs(dir.turn)<0.1) dir.turn=0; // <- turning deadband
	str+="Move "+dir.forward+" forward, "+dir.turn+" turn<br>\n";

//Proportional control.  The 2.0 is because mouse is from -0.5 to +0.5
	dir.forward=dir.forward*2.0*powerUI;
	dir.turn=dir.turn*2.0*powerUI;

	var totPower=Math.abs(dir.forward)+Math.abs(dir.turn);
	var newPower=emptyPower();
	if (frac.x<0.9) { /* normal driving */
		newPower.L=pretty(clamp(dir.forward+dir.turn,-maxPower,maxPower));
		newPower.R=pretty(clamp(dir.forward-dir.turn,-maxPower,maxPower));
	} else { /* right hand corner of screen: special magic values */
		if (frac.y<0.33) {
			newPower.dump=pretty((1.0/6-frac.y)*3);
		} else if (frac.y<0.66) {
			newPower.mine=pretty((3.0/6-frac.y)*3);
		} else {
			newPower.arms=pretty((5.0/6-frac.y)*3);
		}
	}
	var newPowerStr=JSON.stringify(newPower);
	str+="Power "+newPower.L+" left, "+newPower.R+" right, "+newPowerStr+" ";

	if (upState==1) mouse_down=0;
	if (upState==0) mouse_down=1;
	if (mouse_down) {
		arrowDiv.style.backgroundColor='#222222';
		str+=" SENDING";
	} else {
		arrowDiv.style.backgroundColor='#404040';
		newPower=emptyPower();
		totPower=0;
		str+=" (click to send)";
	}
	pilot.power=newPower;
	pilot_send();

	document.getElementById('p_outputPilot').innerHTML=str;

	document.getElementById('glow').style.opacity=clamp(totPower*3.0,0.0,1.0);
	event.stopPropagation();
}

//Open correct AppRTC feed based on robot name entered. Gets run every time the robot name is changed
function updateRTCVideo()
{
  var currentRobot = document.getElementById('robot_videoname').value;
  var splitName = currentRobot.split('/');


 // Use AppRTC instead of gruveo for video
  var videoURL = "https://appear.in/" + splitName[0] + splitName[1];
  // Add parameters to improve video responsiveness
  /*videoURL+="&hd=false";
  videoURL+="&tt=1"; // <- timeout on client very fast
  videoURL+="&audio=googNoiseReduction=true"; // Google noise reduction
  videoURL+="&audio=googEchoCancellation=true"; // Google noise reduction*/
  
  // videoURL+="&video=optional:minWidth=640,optional:minHeight=320";
  //videoURL+="&vsbr=1000&vrbr=1000"; // cut bitrate to 1000 kilobits?
   
  document.getElementById("video_frame").src = videoURL;
  // On Firefox or Chrome, specifying a width and height opens a new window, not a tab.
  //  (On IE, it's up to the user's preferences)
  //window.open(videoURL,"video",'width=800,height=600');

}

//Open Gruveo Video
function openGruveoVideo()
{
  var currentRobot = document.getElementById('robot_name').value;
  var splitName = currentRobot.split('/');

 // Use AppRTC instead of gruveo for video
  var videoURL = "http://gruveo.com/#" + splitName[0] + splitName[1];

  // On Firefox or Chrome, specifying a width and height opens a new window, not a tab.
  //  (On IE, it's up to the user's preferences)
  window.open(videoURL,"video",'width=800,height=600');
}


//Update pilot.RGB variable with currently selected RGB values
function updateRGB()
{
  var the_color_picker=document.getElementById("color_picker");
  var rgb=the_color_picker.color.rgb;

  
  pilot.LED.R=rgb[0];
  document.getElementById('LED_red').value=rgb[0];

  pilot.LED.G=rgb[1];
  document.getElementById('LED_green').value=rgb[1];

  pilot.LED.B=rgb[2];
  document.getElementById('LED_blue').value=rgb[2];

  pilot_send();
}

//Run scripted command, like say or play
function runCmd(run,arg) {
	pilot.cmd.run=run;
	pilot.cmd.arg=arg;
	pilot_send();
}

</script>


<head><title>Pilot for ITEST: Being There</title>

</head>

<body onLoad="run();" style="background-color:#222222;color:#ffccff;">
<center>
<h1>ITEST: Being There Pilot Interface</h1>
</center>

<table>
<tr>
<td><div id="pilot_arrows" style="background-color:#808080;position:relative;width:400px;height:400px;" onmousedown="pilot_mouse(event,0)" ondblclick="pilot_mouse(event,2)" ondragstart="pilot_mouse(event,0)" onmouseout="pilot_mouse(event,1)"  onmouseup="pilot_mouse(event,1)" onmousemove="pilot_mouse(event,2)">
<img src="img/arrows_hard.png" style="position:absolute;left:0px;top:0px;width:100%;height:100%;pointer-events:none;">
<img id="glow" src="img/arrows_glow.png" style="position:absolute;left:0px;top:0px;width:100%;height:100%;pointer-events:none;">
</div></td>
<td style="width:100%;height:100%"><div id="video_area" style="width:100%;height:100%"><iframe id="video_frame" style="width:100%;height:400px" src=""></iframe></div></td>
<tr>
</table>

<div id="tabs">
	<ul>
		<li><a href="#tabs-1">Setup</a></li>
		<li><a href="#tabs-2">Runtime</a></li>
	</ul>
	
	<div id="tabs-1">
		<p>
		Robot Name: <input type="text" id="robot_name" rows="1" cols="30" onChange="run();" value="layla/uaf">
		<input value="Video - Gruveo" type="button" onClick="runCmd('video','r'+((new Date()).getTime())); openGruveoVideo()"><br>

		RTC video name: <input type="text" id="robot_videoname" rows="1" cols="30" onChange="updateRTCVideo()" value="layla/uaf">
		<input value="Video - RTC" type="button" onClick="updateRTCVideo()"><br>

		Drive Power: <input type="text" id="robot_power" rows="1" cols="30" onChange="run()" value="15"><br>

		Pilot Auth: <input type="text" id="robot_auth" rows="1" cols="30" onChange="run()" value=""><br>
		</p>
	</div>

	<div id="tabs-2">
		<p>
		Show text:
		<input type="text" id="robot_showtext" rows="1" cols="30" onChange="runCmd('say',this.value)" value="Hi! ">
		<br>

		Play sounds:
		<input value="Beep 1" type="button" onClick="runCmd('play','music/whistle1.mp3')">
		<input value="Beep 2" type="button" onClick="runCmd('play','music/whistle2.mp3')">
		<input value="Stop" type="button" onClick="runCmd('play','')"><br>

		<!--   -->

		<div id="button_area" style="font-style:italic">
			<table>

			<tr>

			<td>Toggle LED<input id="LEDtoggle" value="LED On" type="checkbox" onClick="LEDtoggle()"></td>
			<td>LED Demo <input  id="LEDdemo" value="LED Demo" type="checkbox" onClick="LEDdemo()" disabled></td> 
			<!--<td><input name ="update_video" value="Open Video" type="button" onClick="updateVideo()"></td>< -->
			<td><input class="color{pickerOnfocus:true}" id="color_picker" onchange = "updateRGB()"></td>
			<!--<td><input name ="LEDoff" value="LED Off" type="button" onClick="LEDtoggle(false)"></td> -->
			</tr>
			<tr>
			<!-- <td><P id="p_LEDstatus"></p></td><!-- Display LED Status below the toggle button -->
			<td></td> <!-- 2 empty cells for Alignment -->
			<td></td>
 
			<td colspan="3">R <input id="LED_red" size="5">  G <input id="LED_green" size="5">  B <input id="LED_blue" size="5">
			</tr>

			</table>

		</div>
		</p>
	</div>
</div>
<script> $( "#tabs" ).tabs(); </script> <!--Has to be placed after tabs-->



<div id="status_area" style="font-style:italic;">
<P id="p_errorout" style="color:red;">ERROR: JavaScript not enabled.</p>

<P id="p_outputRobot">Robot Status</p>
<P id="p_outputNet">Network Status</p>
<P id="p_outputPilot">Pilot Status</p>

</div>
</body></html>
